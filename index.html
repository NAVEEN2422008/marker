<!DOCTYPE html>
<html>
<head>
    <title>AR Solar System</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .ui-element {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 16px;
            z-index: 1000;
        }
        #arInfo {
            top: 20px;
            left: 20px;
            pointer-events: none;
        }
        #loadingProgress {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        .hidden { display: none; }
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <div id="arInfo" class="ui-element">Initializing AR...</div>
    <div id="loadingProgress" class="ui-element">Loading assets: 0%</div>

    <a-scene 
        embedded 
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true;">

        <a-assets timeout="30000">
            <video id="arVideo" 
                src="ar/output/output.mp4"
                preload="auto" 
                loop 
                crossorigin="anonymous"
                playsinline 
                webkit-playsinline>
            </video>
            <a-asset-item id="sunModel" src="https://cdn.glitch.global/your-project/sun.glb"></a-asset-item>
            <a-asset-item id="earthModel" src="https://cdn.glitch.global/your-project/earth.glb"></a-asset-item>
            <a-asset-item id="moonModel" src="https://cdn.glitch.global/your-project/moon.glb"></a-asset-item>
        </a-assets>

        <!-- Solar System Marker -->
        <a-marker preset="custom" type="pattern" url="ar/solar/solar.patt">
            <a-entity id="solarSystem" position="0 0.5 0" scale="0.05 0.05 0.05">
                <!-- Sun -->
                <a-entity 
                    gltf-model="#sunModel"
                    position="0 0 0" 
                    scale="2 2 2"
                    material="shader: standard; emissive: #ff5500; emissiveIntensity: 0.8"
                    animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true">
                </a-entity>
                
                <!-- Earth System -->
                <a-entity id="earthOrbit">
                    <a-entity 
                        gltf-model="#earthModel"
                        position="8 0 0" 
                        scale="1.5 1.5 1.5"
                        animation="property: rotation; to: 0 360 0; dur: 15000; easing: linear; loop: true">
                        
                        <!-- Moon System -->
                        <a-entity id="moonOrbit">
                            <a-entity 
                                gltf-model="#moonModel"
                                position="2 0 0" 
                                scale="0.8 0.8 0.8"
                                animation="property: rotation; to: 0 360 0; dur: 5000; easing: linear; loop: true">
                            </a-entity>
                        </a-entity>
                    </a-entity>
                </a-entity>
            </a-entity>
        </a-marker>

        <!-- Video Marker -->
        <a-marker preset="custom" type="pattern" url="ar/output/output.patt">
            <a-video
                src="#arVideo"
                width="3"
                height="2"
                position="0 0.1 0"
                rotation="-90 0 0"
                material="shader: flat; side: double">
            </a-video>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        (() => {
            // Cache DOM elements
            const elements = {
                video: document.querySelector('#arVideo'),
                info: document.querySelector('#arInfo'),
                progress: document.querySelector('#loadingProgress'),
                videoMarker: document.querySelector('a-marker[url*="video"]'),
                solarMarker: document.querySelector('a-marker[url*="solar"]'),
                earthOrbit: document.querySelector('#earthOrbit'),
                moonOrbit: document.querySelector('#moonOrbit')
            };

            // State management
            const state = {
                animationFrameId: null,
                isPlaying: false,
                assetsLoaded: 0,
                totalAssets: 1, // just video
            };

            // Update UI
            const updateUI = {
                loading: (progress) => {
                    elements.progress.textContent = `Loading assets: ${progress}%`;
                    if (progress >= 100) elements.progress.classList.add('hidden');
                },
                status: (text, color = 'rgba(0, 0, 0, 0.8)') => {
                    elements.info.textContent = text;
                    elements.info.style.backgroundColor = color;
                }
            };

            // Video handling
            const videoHandler = {
                setup: () => {
                    elements.video.addEventListener('loadedmetadata', () => {
                        state.assetsLoaded++;
                        updateUI.loading(100 * (state.assetsLoaded / state.totalAssets));
                        videoHandler.attemptPlay();
                    });

                    elements.video.addEventListener('error', () => {
                        updateUI.status('Video loading failed - Please refresh', 'rgba(255, 0, 0, 0.8)');
                    });
                },
                attemptPlay: () => {
                    elements.video.play()
                        .then(() => state.isPlaying = true)
                        .catch(error => {
                            console.warn('Video autoplay failed:', error);
                            // Auto-retry after 1 second
                            setTimeout(() => videoHandler.attemptPlay(), 1000);
                        });
                }
            };

            // Marker handling
            const markerHandler = {
                videoFound: () => {
                    updateUI.status('ðŸ“¹ Video Playing', 'rgba(0, 100, 255, 0.8)');
                    if (!state.isPlaying) videoHandler.attemptPlay();
                },
                videoLost: () => {
                    if (state.isPlaying) {
                        elements.video.pause();
                        state.isPlaying = false;
                    }
                    markerHandler.resetInfo();
                },
                solarFound: () => {
                    updateUI.status('ðŸŒŽ Solar System Active', 'rgba(0, 200, 100, 0.8)');
                },
                resetInfo: () => {
                    if (!elements.videoMarker.object3D.visible && !elements.solarMarker.object3D.visible) {
                        updateUI.status('Searching for markers...');
                    }
                }
            };

            // Animation
            const animate = () => {
                if (elements.solarMarker.object3D.visible) {
                    elements.earthOrbit.object3D.rotation.y += 0.005;
                    elements.moonOrbit.object3D.rotation.y += 0.015;
                }
                state.animationFrameId = requestAnimationFrame(animate);
            };

            // Cleanup
            const cleanup = () => {
                if (state.animationFrameId) {
                    cancelAnimationFrame(state.animationFrameId);
                    state.animationFrameId = null;
                }
                if (elements.video) {
                    elements.video.pause();
                    elements.video.removeAttribute('src');
                    elements.video.load();
                    state.isPlaying = false;
                }
            };

            // Initialize
            const init = () => {
                videoHandler.setup();
                elements.videoMarker.addEventListener('markerFound', markerHandler.videoFound);
                elements.videoMarker.addEventListener('markerLost', markerHandler.videoLost);
                elements.solarMarker.addEventListener('markerFound', markerHandler.solarFound);
                elements.solarMarker.addEventListener('markerLost', markerHandler.resetInfo);
                animate();
                window.addEventListener('beforeunload', cleanup);
                window.addEventListener('error', (e) => {
                    console.error('AR Error:', e);
                    cleanup();
                    updateUI.status('AR Error - Please refresh', 'rgba(255, 0, 0, 0.8)');
                });
            };

            // Start when DOM is ready
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>
